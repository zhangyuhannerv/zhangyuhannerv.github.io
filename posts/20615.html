<!DOCTYPE html><html lang="en" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><title>linux的常用脚本 | ZhangYuhanのblog</title><meta name="author" content="ZhangYuhan"><meta name="copyright" content="ZhangYuhan"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="检测两台服务器指定目录下的文件一致性#!&#x2F;bin&#x2F;bash  ######################################  检测两台服务器指定目录下的文件一致性  #####################################  #通过对比两台服务器上文件的md5值，达到检测一致性的目的  dir&#x3D;&#x2F;data&#x2F;web  b_ip&#x3D;192.168.88.10  #将指定">
<meta property="og:type" content="article">
<meta property="og:title" content="linux的常用脚本">
<meta property="og:url" content="https://zhangyuhan.netlify.app/posts/20615.html">
<meta property="og:site_name" content="ZhangYuhanのblog">
<meta property="og:description" content="检测两台服务器指定目录下的文件一致性#!&#x2F;bin&#x2F;bash  ######################################  检测两台服务器指定目录下的文件一致性  #####################################  #通过对比两台服务器上文件的md5值，达到检测一致性的目的  dir&#x3D;&#x2F;data&#x2F;web  b_ip&#x3D;192.168.88.10  #将指定">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://www.loliapi.com/acg/?uuid=20615">
<meta property="article:published_time" content="2023-07-24T01:38:21.000Z">
<meta property="article:modified_time" content="2024-11-06T03:52:15.601Z">
<meta property="article:author" content="ZhangYuhan">
<meta property="article:tag" content="Ops">
<meta property="article:tag" content="general">
<meta property="article:tag" content="linux">
<meta property="article:tag" content="常用脚本">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://www.loliapi.com/acg/?uuid=20615"><link rel="shortcut icon" href="/img/theme/favicon.ico"><link rel="canonical" href="https://zhangyuhan.netlify.app/posts/20615.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: 'days',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"Traditional Chinese Activated Manually","cht_to_chs":"Simplified Chinese Activated Manually","day_to_night":"Dark Mode Activated Manually","night_to_day":"Light Mode Activated Manually","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  }
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'linux的常用脚本',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-06 11:52:15'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/font.css"><link rel="stylesheet" href="/css/modify.css"><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/card.css"><link rel="stylesheet" href="/css/custom.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css"/>
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="ZhangYuhanのblog" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/theme/shenhe.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">213</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">278</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">70</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://www.loliapi.com/acg/?uuid=20615')"><nav id="nav"><span id="blog-info"><a href="/" title="ZhangYuhanのblog"><img class="site-icon" src="/img/theme/logo.png"/></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">linux的常用脚本</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-07-24T01:38:21.000Z" title="Created 2023-07-24 09:38:21">2023-07-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2024-11-06T03:52:15.601Z" title="Updated 2024-11-06 11:52:15">2024-11-06</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Ops/">Ops</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Ops/linux/">linux</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Ops/linux/general/">general</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">Word count:</span><span class="word-count">4.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">Reading time:</span><span>22min</span></span><span class="post-meta-separator">|</span><span class="leancloud_visitors" id="/posts/20615.html" data-flag-title="linux的常用脚本"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span class="leancloud-visitors-count"><i class="fa-solid fa-spinner fa-spin"></i></span></span><span class="post-meta-separator">|</span><span class="post-meta-commentcount"><i class="far fa-comments fa-fw post-meta-icon"></i><span class="post-meta-label">Comments:</span><a href="/posts/20615.html#post-comment" itemprop="discussionUrl"><span class="valine-comment-count" data-xid="/posts/20615.html" itemprop="commentCount"><i class="fa-solid fa-spinner fa-spin"></i></span></a></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="检测两台服务器指定目录下的文件一致性"><a href="#检测两台服务器指定目录下的文件一致性" class="headerlink" title="检测两台服务器指定目录下的文件一致性"></a>检测两台服务器指定目录下的文件一致性</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#####################################</span></span>  </span><br><span class="line">检测两台服务器指定目录下的文件一致性  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">####################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过对比两台服务器上文件的md5值，达到检测一致性的目的</span>  </span><br><span class="line">dir=/data/web  </span><br><span class="line">b_ip=192.168.88.10  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将指定目录下的文件全部遍历出来并作为<span class="built_in">md5sum</span>命令的参数，进而得到所有文件的md5值，并写入到指定文件中</span>  </span><br><span class="line">find $dir -type f|xargs md5sum &gt; /tmp/md5_a.txt  </span><br><span class="line">ssh $b_ip &quot;find $dir -type f|xargs md5sum &gt; /tmp/md5_b.txt&quot;  </span><br><span class="line">scp $b_ip:/tmp/md5_b.txt /tmp  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将文件名作为遍历对象进行一一比对</span>  </span><br><span class="line">for f in `awk &#x27;&#123;print 2&#125; /tmp/md5_a.txt&#x27;`do  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">以a机器为标准，当b机器不存在遍历对象中的文件时直接输出不存在的结果</span>  </span><br><span class="line">if grep -qw &quot;$f&quot; /tmp/md5_b.txt  </span><br><span class="line">then  </span><br><span class="line">md5_a=`grep -w &quot;$f&quot; /tmp/md5_a.txt|awk &#x27;&#123;print 1&#125;&#x27;`  </span><br><span class="line">md5_b=`grep -w &quot;$f&quot; /tmp/md5_b.txt|awk &#x27;&#123;print 1&#125;&#x27;`  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当文件存在时，如果md5值不一致则输出文件改变的结果</span>  </span><br><span class="line">if [ $md5_a != $md5_b ]then  </span><br><span class="line">echo &quot;$f changed.&quot;  </span><br><span class="line">fi  </span><br><span class="line">else  </span><br><span class="line">echo &quot;$f deleted.&quot;  </span><br><span class="line">fi  </span><br><span class="line">done  </span><br></pre></td></tr></table></figure>
<h2 id="定时清空文件内容，定时记录文件大小"><a href="#定时清空文件内容，定时记录文件大小" class="headerlink" title="定时清空文件内容，定时记录文件大小"></a>定时清空文件内容，定时记录文件大小</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">################################################################</span></span>  </span><br><span class="line">每小时执行一次脚本（任务计划），当时间为0点或12点时，将目标目录下的所有文件内#容清空，但不删除文件，其他时间则只统计各个文件的大小，一个文件一行，输出到以时#间和日期命名的文件中，需要考虑目标目录下二级、三级等子目录的文件  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span>  </span><br><span class="line">logfile=/tmp/`date +%H-%F`.log  </span><br><span class="line">n=`date +%H`  </span><br><span class="line">if [ $n -eq 00 ] || [ $n -eq 12 ]  </span><br><span class="line">then  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">通过<span class="keyword">for</span>循环，以find命令作为遍历条件，将目标目录下的所有文件进行遍历并做相应操作</span>  </span><br><span class="line">for i in `find /data/log/ -type f`  </span><br><span class="line">do  </span><br><span class="line">true &gt; $i  </span><br><span class="line">done  </span><br><span class="line">else  </span><br><span class="line">for i in `find /data/log/ -type f`  </span><br><span class="line">do  </span><br><span class="line">du -sh $i &gt;&gt; $logfile  </span><br><span class="line">done  </span><br><span class="line">fi  </span><br></pre></td></tr></table></figure>
<h2 id="检测网卡流量，并按规定格式记录在日志中"><a href="#检测网卡流量，并按规定格式记录在日志中" class="headerlink" title="检测网卡流量，并按规定格式记录在日志中"></a>检测网卡流量，并按规定格式记录在日志中</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">######################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">检测网卡流量，并按规定格式记录在日志中<span class="comment">#规定一分钟记录一次</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">日志格式如下所示:</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2019-08-12 20:40</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ens33 input: 1234bps</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">ens33 output: 1235bps</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#####################################################3</span></span>  </span><br><span class="line">while :  </span><br><span class="line">do  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设置语言为英文，保障输出结果是英文，否则会出现bug</span>  </span><br><span class="line">LANG=en  </span><br><span class="line">logfile=/tmp/`date +%d`.log  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将下面执行的命令结果输出重定向到logfile日志中</span>  </span><br><span class="line">exec &gt;&gt; $logfile  </span><br><span class="line">date +&quot;%F %H:%M&quot;  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">sar命令统计的流量单位为kb/s，日志格式为bps，因此要*1000*8</span>  </span><br><span class="line">sar -n DEV 1 59|grep Average|grep ens33|awk &#x27;&#123;print $2,&quot;\t&quot;,&quot;input:&quot;,&quot;\t&quot;,$5*1000*8,&quot;bps&quot;,&quot;\n&quot;,$2,&quot;\t&quot;,&quot;output:&quot;,&quot;\t&quot;,$6*1000*8,&quot;bps&quot;&#125;&#x27;  </span><br><span class="line">echo &quot;####################&quot;  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">因为执行sar命令需要59秒，因此不需要<span class="built_in">sleep</span></span>  </span><br><span class="line">done  </span><br></pre></td></tr></table></figure>
<h2 id="计算文档每行出现的数字个数，并计算整个文档的数字总数"><a href="#计算文档每行出现的数字个数，并计算整个文档的数字总数" class="headerlink" title="计算文档每行出现的数字个数，并计算整个文档的数字总数"></a>计算文档每行出现的数字个数，并计算整个文档的数字总数</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">########################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">计算文档每行出现的数字个数，并计算整个文档的数字总数</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#######################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用awk只输出文档行数（截取第一段）</span>  </span><br><span class="line">n=`wc -l a.txt|awk &#x27;&#123;print $1&#125;&#x27;`  </span><br><span class="line">sum=0  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">文档中每一行可能存在空格，因此不能直接用文档内容进行遍历</span>  </span><br><span class="line">for i in `seq 1 $n`do  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输出的行用变量表示时，需要用双引号</span>  </span><br><span class="line">line=`sed -n &quot;$i&quot;p a.txt`#wc -L选项，统计最长行的长度  </span><br><span class="line">n_n=`echo $line|sed s&#x27;/[^0-9]//&#x27;g|wc -L`  </span><br><span class="line">echo $n_nsum=$[$sum+$n_n]  </span><br><span class="line">done  </span><br><span class="line">echo &quot;sum:$sum&quot;  </span><br></pre></td></tr></table></figure>
<p>杀死所有脚本</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">有一些脚本加入到了cron之中，存在脚本尚未运行完毕又有新任务需要执行的情况，</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">导致系统负载升高，因此可通过编写脚本，筛选出影响负载的进程一次性全部杀死。</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###############################################################</span></span>  </span><br><span class="line">ps aux|grep 指定进程名|grep -v grep|awk &#x27;&#123;print $2&#125;&#x27;|xargs kill -9  </span><br></pre></td></tr></table></figure>
<h2 id="从-FTP-服务器下载文件"><a href="#从-FTP-服务器下载文件" class="headerlink" title="从 FTP 服务器下载文件"></a>从 FTP 服务器下载文件</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">if [ $# -ne 1 ]; then  </span><br><span class="line">    echo &quot;Usage: $0 filename&quot;  </span><br><span class="line">fi  </span><br><span class="line">dir=$(dirname $1)  </span><br><span class="line">file=$(basename $1)  </span><br><span class="line">ftp -n -v &lt;&lt; EOF   # -n 自动登录  </span><br><span class="line">open 192.168.1.10  # ftp服务器  </span><br><span class="line">user admin password  </span><br><span class="line">binary   # 设置ftp传输模式为二进制，避免MD5值不同或.tar.gz压缩包格式错误  </span><br><span class="line">cd $dir  </span><br><span class="line">get &quot;$file&quot;  </span><br><span class="line">EOF  </span><br></pre></td></tr></table></figure>
<h2 id="连续输入5个100以内的数字，统计和、最小和最大"><a href="#连续输入5个100以内的数字，统计和、最小和最大" class="headerlink" title="连续输入5个100以内的数字，统计和、最小和最大"></a>连续输入5个100以内的数字，统计和、最小和最大</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">COUNT=1  </span><br><span class="line">SUM=0  </span><br><span class="line">MIN=0  </span><br><span class="line">MAX=100  </span><br><span class="line">while [ $COUNT -le 5 ]; do  </span><br><span class="line">    read -p &quot;请输入1-10个整数：&quot; INT      </span><br><span class="line">    if [[ ! $INT =~ ^[0-9]+$ ]]; then  </span><br><span class="line">        echo &quot;输入必须是整数！&quot;  </span><br><span class="line">        exit 1  </span><br><span class="line">    elif [[ $INT -gt 100 ]]; then  </span><br><span class="line">        echo &quot;输入必须是100以内！&quot;  </span><br><span class="line">        exit 1  </span><br><span class="line">    fi  </span><br><span class="line">    SUM=$(($SUM+$INT))  </span><br><span class="line">    [ $MIN -lt $INT ] &amp;&amp; MIN=$INT  </span><br><span class="line">    [ $MAX -gt $INT ] &amp;&amp; MAX=$INT  </span><br><span class="line">    let COUNT++  </span><br><span class="line">    done  </span><br><span class="line">echo &quot;SUM: $SUM&quot;  </span><br><span class="line">echo &quot;MIN: $MIN&quot;  </span><br><span class="line">echo &quot;MAX: $MAX  </span><br></pre></td></tr></table></figure>
<p>用户猜数字</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash  <span class="comment"># 脚本生成一个 100 以内的随机数,提示用户猜数字,根据用户的输入,提示用户猜对了,</span></span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">猜小了或猜大了,直至用户猜对脚本结束。</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RANDOM 为系统自带的系统变量,值为 0‐32767的随机数</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用取余算法将随机数变为 1‐100 的随机数num=$[RANDOM%100+1]<span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$num</span>&quot;</span></span>   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 <span class="built_in">read</span> 提示用户猜数字</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用 <span class="keyword">if</span> 判断用户猜数字的大小关系:‐eq(等于),‐ne(不等于),‐gt(大于),‐ge(大于等于),</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">‐lt(小于),‐le(小于等于)</span>  </span><br><span class="line">  </span><br><span class="line">while :  </span><br><span class="line">  do       </span><br><span class="line">    read -p &quot;计算机生成了一个 1‐100 的随机数,你猜: &quot; cai      </span><br><span class="line">    if [ $cai -eq $num ]      </span><br><span class="line">    then          </span><br><span class="line">        echo &quot;恭喜,猜对了&quot;             </span><br><span class="line">        exit          </span><br><span class="line">    elif [ $cai -gt $num ]         </span><br><span class="line">    then              </span><br><span class="line">        echo &quot;Oops,猜大了&quot;           </span><br><span class="line">    else              </span><br><span class="line">        echo &quot;Oops,猜小了&quot;       </span><br><span class="line">    fi  </span><br><span class="line">  done  </span><br></pre></td></tr></table></figure>
<h2 id="监测-Nginx-访问日志-502-情况，并做相应动作"><a href="#监测-Nginx-访问日志-502-情况，并做相应动作" class="headerlink" title="监测 Nginx 访问日志 502 情况，并做相应动作"></a>监测 Nginx 访问日志 502 情况，并做相应动作</h2><p>假设服务器环境为 lnmp，近期访问经常出现 502 现象，且 502 错误在重启 php-fpm 服务后消失，因此需要编写监控脚本，一旦出现 502，则自动重启 php-fpm 服务。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">场景：</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.访问日志文件的路径：/data/log/access.log</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.脚本死循环，每10秒检测一次，10秒的日志条数为300条，出现502的比例不低于10%（30条）则需要重启php-fpm服务</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.重启命令为：/etc/init.d/php-fpm restart</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">监测Nginx访问日志502情况，并做相应动作</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##########################################################</span></span>  </span><br><span class="line">log=/data/log/access.log  </span><br><span class="line">N=30 #设定阈值  </span><br><span class="line">while :do  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">查看访问日志的最新300条，并统计502的次数</span>  </span><br><span class="line">    err=`tail -n 300 $log |grep -c &#x27;502&quot; &#x27;`   </span><br><span class="line">if [ $err -ge $N ]   </span><br><span class="line">then  </span><br><span class="line">/etc/init.d/php-fpm restart 2&gt; /dev/null   </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">设定60s延迟防止脚本bug导致无限重启php-fpm服务</span>  </span><br><span class="line">     sleep 60  </span><br><span class="line"> fi  </span><br><span class="line"> sleep 10  </span><br><span class="line"> done  </span><br></pre></td></tr></table></figure>
<h2 id="将结果分别赋值给变量"><a href="#将结果分别赋值给变量" class="headerlink" title="将结果分别赋值给变量"></a>将结果分别赋值给变量</h2><p>应用场景：希望将执行结果或者位置参数赋值给变量，以便后续使用。</p>
<p>方法1:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for i in $(echo &quot;4 5 6&quot;); do  </span><br><span class="line">   eval a$i=$idone  </span><br><span class="line">echo $a4 $a5 $a6  </span><br></pre></td></tr></table></figure>
<p>方法2：将位置参数192.168.1.1{1,2}拆分为到每个变量</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">num=0  </span><br><span class="line">for i in $(eval echo $*);do   #eval将&#123;1,2&#125;分解为1 2  </span><br><span class="line">   let num+=1  </span><br><span class="line">   eval node$&#123;num&#125;=&quot;$i&quot;  </span><br><span class="line">done  </span><br><span class="line">echo $node1 $node2 $node3  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">bash a.sh 192.168.1.1&#123;1,2&#125;</span>  </span><br><span class="line">192.168.1.11 192.168.1.12  </span><br><span class="line">  </span><br><span class="line">方法3：arr=(4 5 6)  </span><br><span class="line">INDEX1=$(echo $&#123;arr[0]&#125;)  </span><br><span class="line">INDEX2=$(echo $&#123;arr[1]&#125;)  </span><br><span class="line">INDEX3=$(echo $&#123;arr[2]&#125;)  </span><br></pre></td></tr></table></figure>
<h2 id="批量修改文件名"><a href="#批量修改文件名" class="headerlink" title="批量修改文件名"></a>批量修改文件名</h2><p>示例：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">touch</span> article_&#123;1..3&#125;.html</span>  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">lsarticle_1.html  article_2.html  article_3.html</span>  </span><br><span class="line">目的：把article改为bbs  </span><br></pre></td></tr></table></figure>
<p>方法1：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for file in $(ls *html); do  </span><br><span class="line">    mv $file bbs_$&#123;file#*_&#125;  </span><br><span class="line">    # mv $file $(echo $file |sed -r &#x27;s/.*(_.*)/bbs\1/&#x27;)  </span><br><span class="line">    # mv $file $(echo $file |echo bbs_$(cut -d_ -f2)  </span><br></pre></td></tr></table></figure>
<p>方法2：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">for file in $(find . -maxdepth 1 -name &quot;*html&quot;); do  </span><br><span class="line">     mv $file bbs_$&#123;file#*_&#125;done  </span><br></pre></td></tr></table></figure>
<p>方法3：</p>
<p>把一个文档前五行中包含字母的行删掉，同时删除6到10行包含的所有字母  </p>
<p>1）准备测试文件，文件名为2.txt  </p>
<figure class="highlight txt"><table><tr><td class="code"><pre><span class="line">第1行1234567不包含字母  </span><br><span class="line">第2行56789BBBBBB  </span><br><span class="line">第3行67890CCCCCCCC  </span><br><span class="line">第4行78asdfDDDDDDDDD  </span><br><span class="line">第5行123456EEEEEEEE  </span><br><span class="line">第6行1234567ASDF  </span><br><span class="line">第7行56789ASDF  </span><br><span class="line">第8行67890ASDF  </span><br><span class="line">第9行78asdfADSF  </span><br><span class="line">第10行123456AAAA  </span><br><span class="line">第11行67890ASDF  </span><br><span class="line">第12行78asdfADSF  </span><br><span class="line">第13行123456AAAA  </span><br></pre></td></tr></table></figure>
<p>2） 脚本如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##############################################################</span></span>  </span><br><span class="line">把一个文档前五行中包含字母的行删掉，同时删除6到10行包含的所有字母  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line">sed -n &#x27;1,5&#x27;p 2.txt |sed &#x27;/[a-zA-Z]/&#x27;d  </span><br><span class="line">sed -n &#x27;6,10&#x27;p 2.txt |sed s&#x27;/[a-zA-Z]//&#x27;g  </span><br><span class="line">sed -n &#x27;11,$&#x27;p 2.txt  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">最终结果只是在屏幕上打印结果，如果想直接更改文件，可将输出结果写入临时文件中，再替换2.txt或者使用-i选项</span>  </span><br></pre></td></tr></table></figure>
<h2 id="扫描主机端口状态"><a href="#扫描主机端口状态" class="headerlink" title="扫描主机端口状态"></a>扫描主机端口状态</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">HOST=$1  </span><br><span class="line">PORT=&quot;22 25 80 8080&quot;  </span><br><span class="line">for PORT in $PORT; do  </span><br><span class="line">    if echo &amp;&gt;/dev/null &gt; /dev/tcp/$HOST/$PORT; then  </span><br><span class="line">        echo &quot;$PORT open&quot;  </span><br><span class="line">    else  </span><br><span class="line">        echo &quot;$PORT close&quot;  </span><br><span class="line">    fi  </span><br><span class="line">done  </span><br><span class="line">用 shell 打印示例语句中字母数小于6的单词  </span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例语句：</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Bash also interprets a number of multi-character options.</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">shell打印示例语句中字母数小于6的单词</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line">for s in Bash also interprets a number of multi-character options.  </span><br><span class="line">do  </span><br><span class="line"> n=`echo $s|wc -c`   </span><br><span class="line"> if [ $n -lt 6 ]   </span><br><span class="line"> then  </span><br><span class="line"> echo $s  </span><br><span class="line"> fi  </span><br><span class="line">done  </span><br></pre></td></tr></table></figure>
<h2 id="统计当前目录中以-html结尾的文件总大"><a href="#统计当前目录中以-html结尾的文件总大" class="headerlink" title="统计当前目录中以.html结尾的文件总大"></a>统计当前目录中以.html结尾的文件总大</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">find . -name <span class="string">&quot;*.html&quot;</span> -<span class="built_in">exec</span> <span class="built_in">du</span> -k &#123;&#125; \; |awk <span class="string">&#x27;&#123;sum+=$1&#125;END&#123;print sum&#125;&#x27;</span></span>  </span><br><span class="line">  </span><br><span class="line">方法2：  </span><br><span class="line">```bash  </span><br><span class="line">for size in $(ls -l *.html |awk &#x27;&#123;print $5&#125;&#x27;); do  </span><br><span class="line">    sum=$(($sum+$size))  </span><br><span class="line">done  </span><br><span class="line">echo $sum  </span><br><span class="line">```shell</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 扫描主机端口状态</span></span></span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">HOST=$1  </span><br><span class="line">PORT=&quot;22 25 80 8080&quot;  </span><br><span class="line">for PORT in $PORT; do  </span><br><span class="line">    if echo &amp;&gt;/dev/null &gt; /dev/tcp/$HOST/$PORT; then  </span><br><span class="line">        echo &quot;$PORT open&quot;  </span><br><span class="line">    else  </span><br><span class="line">        echo &quot;$PORT close&quot;  </span><br><span class="line">    fi  </span><br><span class="line">done  </span><br><span class="line">用 shell 打印示例语句中字母数小于6的单词  </span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">示例语句：</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">Bash also interprets a number of multi-character options.</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">shell打印示例语句中字母数小于6的单词</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line">for s in Bash also interprets a number of multi-character options.  </span><br><span class="line">do  </span><br><span class="line"> n=`echo $s|wc -c`   </span><br><span class="line"> if [ $n -lt 6 ]   </span><br><span class="line"> then  </span><br><span class="line"> echo $s  </span><br><span class="line"> fi  </span><br><span class="line">done  </span><br></pre></td></tr></table></figure>
<h2 id="输入数字运行相应命令"><a href="#输入数字运行相应命令" class="headerlink" title="输入数字运行相应命令"></a>输入数字运行相应命令</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">输入数字运行相应命令</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line">echo &quot;*cmd menu* 1-date 2-ls 3-who 4-pwd 0-exit &quot;  </span><br><span class="line">while :  </span><br><span class="line">do  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">捕获用户键入值</span>  </span><br><span class="line"> read -p &quot;please input number :&quot; n  </span><br><span class="line"> n1=`echo $n|sed s&#x27;/[0-9]//&#x27;g`  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">空输入检测</span>   </span><br><span class="line"> if [ -z &quot;$n&quot; ]  </span><br><span class="line"> then  </span><br><span class="line"> continue  </span><br><span class="line"> fi  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">非数字输入检测</span>   </span><br><span class="line"> if [ -n &quot;$n1&quot; ]  </span><br><span class="line"> then  </span><br><span class="line"> exit 0  </span><br><span class="line"> fi  </span><br><span class="line"> break  </span><br><span class="line">done  </span><br><span class="line">case $n in  </span><br><span class="line"> 1)  </span><br><span class="line"> date  </span><br><span class="line"> ;;  </span><br><span class="line"> 2)  </span><br><span class="line"> ls  </span><br><span class="line"> ;;  </span><br><span class="line"> 3)  </span><br><span class="line"> who  </span><br><span class="line"> ;;  </span><br><span class="line"> 4)  </span><br><span class="line"> pwd  </span><br><span class="line"> ;;  </span><br><span class="line"> 0)  </span><br><span class="line"> break  </span><br><span class="line"> ;;  </span><br><span class="line">    #输入数字非1-4的提示  </span><br><span class="line"> *)  </span><br><span class="line"> echo &quot;please input number is [1-4]&quot;  </span><br><span class="line">esac  </span><br></pre></td></tr></table></figure>
<h2 id="Expect-实现-SSH-免交互执行命令"><a href="#Expect-实现-SSH-免交互执行命令" class="headerlink" title="Expect 实现 SSH 免交互执行命令"></a>Expect 实现 SSH 免交互执行命令</h2><p>Expect是一个自动交互式应用程序的工具，如telnet，ftp，passwd等。</p>
<p>需先安装expect软件包。</p>
<p>方法1：EOF标准输出作为expect标准输入</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">USER=root  </span><br><span class="line">PASS=123.com  </span><br><span class="line">IP=192.168.1.120  </span><br><span class="line">expect &lt;&lt; EOFset timeout 30spawn ssh $USER@$IP   expect &#123;    &quot;(yes/no)&quot; &#123;send &quot;yes\r&quot;; exp_continue&#125;    &quot;password:&quot; &#123;send &quot;$PASS\r&quot;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">expect &quot;$USER@*&quot;  &#123;send &quot;$1\r&quot;&#125;  </span><br><span class="line">expect &quot;$USER@*&quot;  &#123;send &quot;exit\r&quot;&#125;  </span><br><span class="line">expect eof  </span><br><span class="line">EOF  </span><br></pre></td></tr></table></figure>
<p>方法2：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">USER=root  </span><br><span class="line">PASS=123.com  </span><br><span class="line">IP=192.168.1.120  </span><br><span class="line">expect -c &quot;  </span><br><span class="line">    spawn ssh $USER@$IP  </span><br><span class="line">    expect &#123;  </span><br><span class="line">        \&quot;(yes/no)\&quot; &#123;send \&quot;yes\r\&quot;; exp_continue&#125;  </span><br><span class="line">        \&quot;password:\&quot; &#123;send \&quot;$PASS\r\&quot;; exp_continue&#125;  </span><br><span class="line">        \&quot;$USER@*\&quot; &#123;send \&quot;df -h\r exit\r\&quot;; exp_continue&#125;  </span><br><span class="line">    &#125;&quot;  </span><br></pre></td></tr></table></figure>
<p>方法3：将expect脚本独立出来</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">登录脚本：  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> login.exp</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/usr/bin/expect</span>  </span><br><span class="line">set ip [lindex $argv 0]  </span><br><span class="line">set user [lindex $argv 1]  </span><br><span class="line">set passwd [lindex $argv 2]  </span><br><span class="line">set cmd [lindex $argv 3]  </span><br><span class="line">if &#123; $argc != 4 &#125; &#123;  </span><br><span class="line">puts &quot;Usage: expect login.exp ip user passwd&quot;  </span><br><span class="line">exit 1  </span><br><span class="line">&#125;  </span><br><span class="line">set timeout 30  </span><br><span class="line">spawn ssh $user@$ip  </span><br><span class="line">expect &#123;      </span><br><span class="line">    &quot;(yes/no)&quot; &#123;send &quot;yes\r&quot;; exp_continue&#125;  </span><br><span class="line">    &quot;password:&quot; &#123;send &quot;$passwd\r&quot;&#125;  </span><br><span class="line">&#125;  </span><br><span class="line">expect &quot;$user@*&quot;  &#123;send &quot;$cmd\r&quot;&#125;  </span><br><span class="line">expect &quot;$user@*&quot;  &#123;send &quot;exit\r&quot;&#125;  </span><br><span class="line">expect eof  </span><br></pre></td></tr></table></figure>
<p>执行命令脚本：写个循环可以批量操作多台服务器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">HOST_INFO=user_info.txt  </span><br><span class="line">for ip in $(awk &#x27;&#123;print $1&#125;&#x27; $HOST_INFO)  </span><br><span class="line">do  </span><br><span class="line">    user=$(awk -v I=&quot;$ip&quot; &#x27;I==$1&#123;print $2&#125;&#x27; $HOST_INFO)  </span><br><span class="line">    pass=$(awk -v I=&quot;$ip&quot; &#x27;I==$1&#123;print $3&#125;&#x27; $HOST_INFO)  </span><br><span class="line">    expect login.exp $ip $user $pass $1  </span><br><span class="line">done  </span><br><span class="line">Linux主机SSH连接信息：  </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> user_info.txt</span>  </span><br><span class="line">192.168.1.120 root 123456  </span><br><span class="line">创建10个用户，并分别设置密码，密码要求10位且包含大小写字母以及数字，最后需要把每个用户的密码存在指定文件中  </span><br><span class="line">```bash  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建10个用户，并分别设置密码，密码要求10位且包含大小写字母以及数字</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">最后需要把每个用户的密码存在指定文件中<span class="comment">#前提条件：安装mkpasswd命令</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">#############################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成10个用户的序列（00-09）</span>  </span><br><span class="line">for u in `seq -w 0 09`do  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">创建用户</span>  </span><br><span class="line"> useradd user_$u  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">生成密码</span>  </span><br><span class="line"> p=`mkpasswd -s 0 -l 10`   </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">从标准输入中读取密码进行修改（不安全）</span>  </span><br><span class="line"> echo $p|passwd --stdin user_$u  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">常规修改密码</span>  </span><br><span class="line"> echo -e &quot;$p\n$p&quot;|passwd user_$u  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">将创建的用户及对应的密码记录到日志文件中</span>  </span><br><span class="line"> echo &quot;user_$u $p&quot; &gt;&gt; /tmp/userpassworddone  </span><br></pre></td></tr></table></figure>
<h2 id="监控-httpd-的进程数，根据监控情况做相应处理"><a href="#监控-httpd-的进程数，根据监控情况做相应处理" class="headerlink" title="监控 httpd 的进程数，根据监控情况做相应处理"></a>监控 httpd 的进程数，根据监控情况做相应处理</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##############################################################################################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">需求：</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">1.每隔10s监控httpd的进程数，若进程数大于等于500，则自动重启Apache服务，并检测服务是否重启成功</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">2.若未成功则需要再次启动，若重启5次依旧没有成功，则向管理员发送告警邮件，并退出检测</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">3.如果启动成功，则等待1分钟后再次检测httpd进程数，若进程数正常，则恢复正常检测（10s一次），否则放弃重启并向管理员发送告警邮件，并退出检测</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">##############################################################################################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">计数器函数</span>  </span><br><span class="line">check_service()  </span><br><span class="line">&#123;  </span><br><span class="line"> j=0  </span><br><span class="line"> for i in `seq 1 5`   </span><br><span class="line"> do  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">重启Apache的命令</span>  </span><br><span class="line"> /usr/local/apache2/bin/apachectl restart 2&gt; /var/log/httpderr.log      </span><br><span class="line">    #判断服务是否重启成功  </span><br><span class="line"> if [ $? -eq 0 ] then  </span><br><span class="line"> break  </span><br><span class="line"> else  </span><br><span class="line"> j=$[$j+1] fi  </span><br><span class="line">    #判断服务是否已尝试重启5次  </span><br><span class="line"> if [ $j -eq 5 ] then  </span><br><span class="line"> mail.py exit  </span><br><span class="line"> fi  </span><br><span class="line"> done &#125;while :do  </span><br><span class="line"> n=`pgrep -l httpd|wc -l`   </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">判断httpd服务进程数是否超过500</span>  </span><br><span class="line"> if [ $n -gt 500 ] then  </span><br><span class="line"> /usr/local/apache2/bin/apachectl restart   </span><br><span class="line"> if [ $? -ne 0 ]   </span><br><span class="line"> then  </span><br><span class="line"> check_service   </span><br><span class="line"> else  </span><br><span class="line"> sleep 60  </span><br><span class="line"> n2=`pgrep -l httpd|wc -l`   </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">判断重启后是否依旧超过500</span>  </span><br><span class="line">             if [ $n2 -gt 500 ]   </span><br><span class="line"> then   </span><br><span class="line"> mail.py exit  </span><br><span class="line"> fi  </span><br><span class="line"> fi  </span><br><span class="line"> fi  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">每隔10s检测一次</span>  </span><br><span class="line"> sleep 10done  </span><br></pre></td></tr></table></figure>
<h2 id="批量修改服务器用户密码"><a href="#批量修改服务器用户密码" class="headerlink" title="批量修改服务器用户密码"></a>批量修改服务器用户密码</h2><p> Linux主机SSH连接信息：旧密码</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> old_pass.txt</span>   </span><br><span class="line">192.168.18.217  root    123456     22  </span><br><span class="line">192.168.18.218  root    123456     22  </span><br><span class="line">内容格式：IP User Password Port  </span><br><span class="line">  </span><br><span class="line">SSH远程修改密码脚本：新密码随机生成  </span><br><span class="line">https://www.linuxprobe.com/books  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">OLD_INFO=old_pass.txt  </span><br><span class="line">NEW_INFO=new_pass.txt  </span><br><span class="line">for IP in $(awk &#x27;/^[^#]/&#123;print $1&#125;&#x27; $OLD_INFO); do  </span><br><span class="line">    USER=$(awk -v I=$IP &#x27;I==$1&#123;print $2&#125;&#x27; $OLD_INFO)  </span><br><span class="line">    PASS=$(awk -v I=$IP &#x27;I==$1&#123;print $3&#125;&#x27; $OLD_INFO)  </span><br><span class="line">    PORT=$(awk -v I=$IP &#x27;I==$1&#123;print $4&#125;&#x27; $OLD_INFO)  </span><br><span class="line">    NEW_PASS=$(mkpasswd -l 8)  # 随机密码  </span><br><span class="line">    echo &quot;$IP   $USER   $NEW_PASS   $PORT&quot; &gt;&gt; $NEW_INFO  </span><br><span class="line">    expect -c &quot;  </span><br><span class="line">    spawn ssh -p$PORT $USER@$IP  </span><br><span class="line">    set timeout 2  </span><br><span class="line">    expect &#123;  </span><br><span class="line">        \&quot;(yes/no)\&quot; &#123;send \&quot;yes\r\&quot;;exp_continue&#125;  </span><br><span class="line">        \&quot;password:\&quot; &#123;send \&quot;$PASS\r\&quot;;exp_continue&#125;  </span><br><span class="line">        \&quot;$USER@*\&quot; &#123;send \&quot;echo \&#x27;$NEW_PASS\&#x27; |passwd --stdin $USER\r exit\r\&quot;;exp_continue&#125;  </span><br><span class="line">    &#125;&quot;  </span><br><span class="line">done  </span><br><span class="line">生成新密码文件：  </span><br><span class="line"><span class="meta prompt_">  </span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cat</span> new_pass.txt</span>   </span><br><span class="line">192.168.18.217  root    n8wX3mU%      22  </span><br><span class="line">192.168.18.218  root    c87;ZnnL      22  </span><br></pre></td></tr></table></figure>
<h2 id="iptables-自动屏蔽访问网站频繁的IP"><a href="#iptables-自动屏蔽访问网站频繁的IP" class="headerlink" title="iptables 自动屏蔽访问网站频繁的IP"></a>iptables 自动屏蔽访问网站频繁的IP</h2><p>场景：恶意访问,安全防范</p>
<p>1）屏蔽每分钟访问超过200的IP</p>
<p>方法1：根据访问日志（Nginx为例）</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">DATE=$(date +%d/%b/%Y:%H:%M)  </span><br><span class="line">ABNORMAL_IP=$(tail -n5000 access.log |grep $DATE |awk &#x27;&#123;a[$1]++&#125;END&#123;for(i in a)if(a[i]&gt;100)print i&#125;&#x27;)  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">先<span class="built_in">tail</span>防止文件过大，读取慢，数字可调整每分钟最大的访问量。awk不能直接过滤日志，因为包含特殊字符。</span>  </span><br><span class="line">for IP in $ABNORMAL_IP; do  </span><br><span class="line">    if [ $(iptables -vnL |grep -c &quot;$IP&quot;) -eq 0 ]; then  </span><br><span class="line">        iptables -I INPUT -s $IP -j DROP    fidone  </span><br></pre></td></tr></table></figure>
<p>方法2：通过TCP建立的连接</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">ABNORMAL_IP=$(netstat -an |awk &#x27;$4~/:80$/ &amp;&amp; $6~/ESTABLISHED/&#123;gsub(/:[0-9]+/,&quot;&quot;,$5);&#123;a[$5]++&#125;&#125;END&#123;for(i in a)if(a[i]&gt;100)print i&#125;&#x27;)  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">gsub是将第五列（客户端IP）的冒号和端口去掉</span>  </span><br><span class="line">for IP in $ABNORMAL_IP; do  </span><br><span class="line">    if [ $(iptables -vnL |grep -c &quot;$IP&quot;) -eq 0 ]; then  </span><br><span class="line">        iptables -I INPUT -s $IP -j DROP      </span><br><span class="line">        fi  </span><br><span class="line">done  </span><br></pre></td></tr></table></figure>
<p>2）屏蔽每分钟SSH尝试登录超过10次的IP</p>
<p>方法1：通过lastb获取登录状态:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">DATE=$(date +&quot;%a %b %e %H:%M&quot;) #星期月天时分  %e单数字时显示7，而%d显示07  </span><br><span class="line">ABNORMAL_IP=$(lastb |grep &quot;$DATE&quot; |awk &#x27;&#123;a[$3]++&#125;END&#123;for(i in a)if(a[i]&gt;10)print i&#125;&#x27;)for IP in $ABNORMAL_IP; do  </span><br><span class="line">    if [ $(iptables -vnL |grep -c &quot;$IP&quot;) -eq 0 ]; then  </span><br><span class="line">        iptables -I INPUT -s $IP -j DROP    fidone  </span><br></pre></td></tr></table></figure>
<p>方法2：通过日志获取登录状态</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">DATE=$(date +&quot;%b %d %H&quot;)  </span><br><span class="line">ABNORMAL_IP=&quot;$(tail -n10000 /var/log/auth.log |grep &quot;$DATE&quot; |awk &#x27;/Failed/&#123;a[$(NF-3)]++&#125;END&#123;for(i in a)if(a[i]&gt;5)print i&#125;&#x27;)&quot;  </span><br><span class="line">for IP in $ABNORMAL_IP; do  </span><br><span class="line">    if [ $(iptables -vnL |grep -c &quot;$IP&quot;) -eq 0 ]; then  </span><br><span class="line">        iptables -A INPUT -s $IP -j DROP          </span><br><span class="line">        echo &quot;$(date +&quot;%F %T&quot;) - iptables -A INPUT -s $IP -j DROP&quot; &gt;&gt;~/ssh-login-limit.log      </span><br><span class="line">    fi  </span><br><span class="line">done  </span><br></pre></td></tr></table></figure>
<h2 id="根据web访问日志，封禁请求量异常的IP，如IP在半小时后恢复正常，则解除封禁"><a href="#根据web访问日志，封禁请求量异常的IP，如IP在半小时后恢复正常，则解除封禁" class="headerlink" title="根据web访问日志，封禁请求量异常的IP，如IP在半小时后恢复正常，则解除封禁"></a>根据web访问日志，封禁请求量异常的IP，如IP在半小时后恢复正常，则解除封禁</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###################################################################################</span></span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">根据web访问日志，封禁请求量异常的IP，如IP在半小时后恢复正常，则解除封禁</span>  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">###################################################################################</span></span>  </span><br><span class="line">logfile=/data/log/access.log  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">显示一分钟前的小时和分钟</span>  </span><br><span class="line">d1=`date -d &quot;-1 minute&quot; +%H%M`  </span><br><span class="line">d2=`date +%M`  </span><br><span class="line">ipt=/sbin/iptables  </span><br><span class="line">ips=/tmp/ips.txt  </span><br><span class="line">block()  </span><br><span class="line">&#123;   </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将一分钟前的日志全部过滤出来并提取IP以及统计访问次数</span>  </span><br><span class="line"> grep &#x27;$d1:&#x27; $logfile|awk &#x27;&#123;print $1&#125;&#x27;|sort -n|uniq -c|sort -n &gt; $ips  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">利用<span class="keyword">for</span>循环将次数超过100的IP依次遍历出来并予以封禁</span>  </span><br><span class="line"> for i in `awk &#x27;$1&gt;100 &#123;print $2&#125;&#x27; $ips`   </span><br><span class="line"> do  </span><br><span class="line"><span class="meta prompt_"> $</span><span class="language-bash">ipt -I INPUT -p tcp --dport 80 -s <span class="variable">$i</span> -j REJECT</span>   </span><br><span class="line"> echo &quot;`date +%F-%T` $i&quot; &gt;&gt; /tmp/badip.log   </span><br><span class="line"> done  </span><br><span class="line">&#125;  </span><br><span class="line">unblock()  </span><br><span class="line">&#123;   </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">将封禁后所产生的pkts数量小于10的IP依次遍历予以解封</span>  </span><br><span class="line"> for a in `$ipt -nvL INPUT --line-numbers |grep &#x27;0.0.0.0/0&#x27;|awk &#x27;$2&lt;10 &#123;print $1&#125;&#x27;|sort -nr`   </span><br><span class="line"> do   </span><br><span class="line"><span class="meta prompt_"> $</span><span class="language-bash">ipt -D INPUT <span class="variable">$a</span></span>  </span><br><span class="line"> done  </span><br><span class="line"><span class="meta prompt_"> $</span><span class="language-bash">ipt -Z</span>  </span><br><span class="line">&#125;  </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">当时间在00分以及30分时执行解封函数</span>  </span><br><span class="line">if [ $d2 -eq &quot;00&quot; ] || [ $d2 -eq &quot;30&quot; ]   </span><br><span class="line"> then  </span><br><span class="line"><span class="meta prompt_"> #</span><span class="language-bash">要先解再封，因为刚刚封禁时产生的pkts数量很少</span>  </span><br><span class="line"> unblock  </span><br><span class="line"> block   </span><br><span class="line"> else  </span><br><span class="line"> block  </span><br><span class="line">fi  </span><br></pre></td></tr></table></figure>
<h2 id="判断用户输入的是否为IP地址"><a href="#判断用户输入的是否为IP地址" class="headerlink" title="判断用户输入的是否为IP地址"></a>判断用户输入的是否为IP地址</h2><p>方法1:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">function check_ip()&#123;  </span><br><span class="line">    IP=$1  </span><br><span class="line">    VALID_CHECK=$(echo $IP|awk -F. &#x27;$1&lt; =255&amp;&amp;$2&lt;=255&amp;&amp;$3&lt;=255&amp;&amp;$4&lt;=255&#123;print &quot;yes&quot;&#125;&#x27;)  </span><br><span class="line">    if echo $IP|grep -E &quot;^[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;$&quot;&gt;/dev/null; then  </span><br><span class="line">        if [ $VALID_CHECK == &quot;yes&quot; ]; then  </span><br><span class="line">            echo &quot;$IP available.&quot;  </span><br><span class="line">        else  </span><br><span class="line">            echo &quot;$IP not available!&quot;  </span><br><span class="line">        fi  </span><br><span class="line">    else  </span><br><span class="line">        echo &quot;Format error!&quot;  </span><br><span class="line">    fi  </span><br><span class="line">&#125;  </span><br><span class="line">check_ip 192.168.1.1  </span><br><span class="line">check_ip 256.1.1.1  </span><br></pre></td></tr></table></figure>
<p>方法2：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">function check_ip()&#123;  </span><br><span class="line">    IP=$1  </span><br><span class="line">    if [[ $IP =~ ^[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;$ ]]; then  </span><br><span class="line">        FIELD1=$(echo $IP|cut -d. -f1)  </span><br><span class="line">        FIELD2=$(echo $IP|cut -d. -f2)  </span><br><span class="line">        FIELD3=$(echo $IP|cut -d. -f3)  </span><br><span class="line">        FIELD4=$(echo $IP|cut -d. -f4)  </span><br><span class="line">        if [ $FIELD1 -le 255 -a $FIELD2 -le 255 -a $FIELD3 -le 255 -a $FIELD4 -le 255 ]; then  </span><br><span class="line">            echo &quot;$IP available.&quot;  </span><br><span class="line">        else  </span><br><span class="line">            echo &quot;$IP not available!&quot;  </span><br><span class="line">        fi  </span><br><span class="line">    else  </span><br><span class="line">        echo &quot;Format error!&quot;  </span><br><span class="line">    fi  </span><br><span class="line">&#125;  </span><br><span class="line">check_ip 192.168.1.1  </span><br><span class="line">check_ip 256.1.1.1  </span><br></pre></td></tr></table></figure>
<p>增加版：</p>
<p>加个死循环，如果IP可用就退出，不可用提示继续输入，并使用awk判断。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span>  </span><br><span class="line">function check_ip()&#123;  </span><br><span class="line">    local IP=$1  </span><br><span class="line">    VALID_CHECK=$(echo $IP|awk -F. &#x27;$1&lt; =255&amp;&amp;$2&lt;=255&amp;&amp;$3&lt;=255&amp;&amp;$4&lt;=255&#123;print &quot;yes&quot;&#125;&#x27;)  </span><br><span class="line">    if echo $IP|grep -E &quot;^[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;\.[0-9]&#123;1,3&#125;$&quot; &gt;/dev/null; then  </span><br><span class="line">        if [ $VALID_CHECK == &quot;yes&quot; ]; then  </span><br><span class="line">            return 0  </span><br><span class="line">        else  </span><br><span class="line">            echo &quot;$IP not available!&quot;  </span><br><span class="line">            return 1  </span><br><span class="line">        fi  </span><br><span class="line">    else  </span><br><span class="line">        echo &quot;Format error! Please input again.&quot;  </span><br><span class="line">        return 1  </span><br><span class="line">    fi  </span><br><span class="line">&#125;  </span><br><span class="line">while true; do  </span><br><span class="line">    read -p &quot;Please enter IP: &quot; IP  </span><br><span class="line">    check_ip $IP  </span><br><span class="line">    [ $? -eq 0 ] &amp;&amp; break || continue  </span><br><span class="line">done  </span><br></pre></td></tr></table></figure>
<p>转载自<br><a target="_blank" rel="noopener external nofollow noreferrer" href="https://mp.weixin.qq.com/s/FrVj5bZfMYsxoQxgQAMJ_A">18个一线工作中常用 Shell 脚本, 太好用啦~</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="https://zhangyuhan.netlify.app/">ZhangYuhan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://zhangyuhan.netlify.app/posts/20615.html">https://zhangyuhan.netlify.app/posts/20615.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener external nofollow noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Ops/">Ops</a><a class="post-meta__tags" href="/tags/general/">general</a><a class="post-meta__tags" href="/tags/linux/">linux</a><a class="post-meta__tags" href="/tags/%E5%B8%B8%E7%94%A8%E8%84%9A%E6%9C%AC/">常用脚本</a></div><div class="post_share"><div class="social-share" data-image="https://www.loliapi.com/acg/?uuid=20615" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> Donate</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/theme/wechat.png" target="_blank"><img class="post-qr-code-img" src="/img/theme/wechat.png" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/theme/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/theme/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/8695.html" title="linux上停止mysql报错的解决办法"><img class="cover" src="https://www.loliapi.com/acg/?uuid=8695" onerror="onerror=null;src='/img/theme/pictureLost.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">linux上停止mysql报错的解决办法</div></div></a></div><div class="next-post pull-right"><a href="/posts/58200.html" title="Arrays.asList() 的坑"><img class="cover" src="https://www.loliapi.com/acg/?uuid=58200" onerror="onerror=null;src='/img/theme/pictureLost.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Arrays.asList() 的坑</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/posts/22256.html" title="创建shell脚本并且运行"><img class="cover" src="https://www.loliapi.com/acg/?uuid=311a6ecfb7884676845d3fa5bc75d5d5" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-06</div><div class="title">创建shell脚本并且运行</div></div></a></div><div><a href="/posts/60780.html" title="后台运行命令"><img class="cover" src="https://www.loliapi.com/acg/?uuid=14306e63fe4a401e8ad9a6b69f6b6c82" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-06</div><div class="title">后台运行命令</div></div></a></div><div><a href="/posts/50313.html" title="查看命令所在源文件的位置"><img class="cover" src="https://www.loliapi.com/acg/?uuid=79ead9852c524fa4a6ac19fb37356d24" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-06</div><div class="title">查看命令所在源文件的位置</div></div></a></div><div><a href="/posts/9243.html" title="查看日志最后几行"><img class="cover" src="https://www.loliapi.com/acg/?uuid=933ac955cd9347108109cca1c0894812" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-06</div><div class="title">查看日志最后几行</div></div></a></div><div><a href="/posts/58898.html" title="查看后台运行的java -jar项目的端口号，并杀死该进程"><img class="cover" src="https://www.loliapi.com/acg/?uuid=0dc71164065c470b8c74e05f3bdb1619" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-06</div><div class="title">查看后台运行的java -jar项目的端口号，并杀死该进程</div></div></a></div><div><a href="/posts/1698.html" title="查看cpu核心数"><img class="cover" src="https://www.loliapi.com/acg/?uuid=8ee4b864344942f28fdf1a2281c87cb8" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-03-06</div><div class="title">查看cpu核心数</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> Comment</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/theme/shenhe.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">ZhangYuhan</div><div class="author-info__description">(o゜▽゜)o☆[BINGO!]</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">213</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">278</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">70</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://twitter.com/ayanamiichi"><i class="fa-brands fa-twitter"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/zhangyuhannerv" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:zhangyuhannerv@gmail.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Welcome to my blog, here is a summary of my daily study and life collected and organized, I hope it can be helpful to you ^_^</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E4%B8%A4%E5%8F%B0%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%8C%87%E5%AE%9A%E7%9B%AE%E5%BD%95%E4%B8%8B%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%80%E8%87%B4%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">检测两台服务器指定目录下的文件一致性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E6%B8%85%E7%A9%BA%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%EF%BC%8C%E5%AE%9A%E6%97%B6%E8%AE%B0%E5%BD%95%E6%96%87%E4%BB%B6%E5%A4%A7%E5%B0%8F"><span class="toc-number">2.</span> <span class="toc-text">定时清空文件内容，定时记录文件大小</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A3%80%E6%B5%8B%E7%BD%91%E5%8D%A1%E6%B5%81%E9%87%8F%EF%BC%8C%E5%B9%B6%E6%8C%89%E8%A7%84%E5%AE%9A%E6%A0%BC%E5%BC%8F%E8%AE%B0%E5%BD%95%E5%9C%A8%E6%97%A5%E5%BF%97%E4%B8%AD"><span class="toc-number">3.</span> <span class="toc-text">检测网卡流量，并按规定格式记录在日志中</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E6%96%87%E6%A1%A3%E6%AF%8F%E8%A1%8C%E5%87%BA%E7%8E%B0%E7%9A%84%E6%95%B0%E5%AD%97%E4%B8%AA%E6%95%B0%EF%BC%8C%E5%B9%B6%E8%AE%A1%E7%AE%97%E6%95%B4%E4%B8%AA%E6%96%87%E6%A1%A3%E7%9A%84%E6%95%B0%E5%AD%97%E6%80%BB%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">计算文档每行出现的数字个数，并计算整个文档的数字总数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E-FTP-%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8B%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">5.</span> <span class="toc-text">从 FTP 服务器下载文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9E%E7%BB%AD%E8%BE%93%E5%85%A55%E4%B8%AA100%E4%BB%A5%E5%86%85%E7%9A%84%E6%95%B0%E5%AD%97%EF%BC%8C%E7%BB%9F%E8%AE%A1%E5%92%8C%E3%80%81%E6%9C%80%E5%B0%8F%E5%92%8C%E6%9C%80%E5%A4%A7"><span class="toc-number">6.</span> <span class="toc-text">连续输入5个100以内的数字，统计和、最小和最大</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%B5%8B-Nginx-%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97-502-%E6%83%85%E5%86%B5%EF%BC%8C%E5%B9%B6%E5%81%9A%E7%9B%B8%E5%BA%94%E5%8A%A8%E4%BD%9C"><span class="toc-number">7.</span> <span class="toc-text">监测 Nginx 访问日志 502 情况，并做相应动作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%86%E7%BB%93%E6%9E%9C%E5%88%86%E5%88%AB%E8%B5%8B%E5%80%BC%E7%BB%99%E5%8F%98%E9%87%8F"><span class="toc-number">8.</span> <span class="toc-text">将结果分别赋值给变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E6%96%87%E4%BB%B6%E5%90%8D"><span class="toc-number">9.</span> <span class="toc-text">批量修改文件名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%AB%E6%8F%8F%E4%B8%BB%E6%9C%BA%E7%AB%AF%E5%8F%A3%E7%8A%B6%E6%80%81"><span class="toc-number">10.</span> <span class="toc-text">扫描主机端口状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E5%BD%93%E5%89%8D%E7%9B%AE%E5%BD%95%E4%B8%AD%E4%BB%A5-html%E7%BB%93%E5%B0%BE%E7%9A%84%E6%96%87%E4%BB%B6%E6%80%BB%E5%A4%A7"><span class="toc-number">11.</span> <span class="toc-text">统计当前目录中以.html结尾的文件总大</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E6%95%B0%E5%AD%97%E8%BF%90%E8%A1%8C%E7%9B%B8%E5%BA%94%E5%91%BD%E4%BB%A4"><span class="toc-number">12.</span> <span class="toc-text">输入数字运行相应命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Expect-%E5%AE%9E%E7%8E%B0-SSH-%E5%85%8D%E4%BA%A4%E4%BA%92%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4"><span class="toc-number">13.</span> <span class="toc-text">Expect 实现 SSH 免交互执行命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7-httpd-%E7%9A%84%E8%BF%9B%E7%A8%8B%E6%95%B0%EF%BC%8C%E6%A0%B9%E6%8D%AE%E7%9B%91%E6%8E%A7%E6%83%85%E5%86%B5%E5%81%9A%E7%9B%B8%E5%BA%94%E5%A4%84%E7%90%86"><span class="toc-number">14.</span> <span class="toc-text">监控 httpd 的进程数，根据监控情况做相应处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E4%BF%AE%E6%94%B9%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81"><span class="toc-number">15.</span> <span class="toc-text">批量修改服务器用户密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iptables-%E8%87%AA%E5%8A%A8%E5%B1%8F%E8%94%BD%E8%AE%BF%E9%97%AE%E7%BD%91%E7%AB%99%E9%A2%91%E7%B9%81%E7%9A%84IP"><span class="toc-number">16.</span> <span class="toc-text">iptables 自动屏蔽访问网站频繁的IP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AEweb%E8%AE%BF%E9%97%AE%E6%97%A5%E5%BF%97%EF%BC%8C%E5%B0%81%E7%A6%81%E8%AF%B7%E6%B1%82%E9%87%8F%E5%BC%82%E5%B8%B8%E7%9A%84IP%EF%BC%8C%E5%A6%82IP%E5%9C%A8%E5%8D%8A%E5%B0%8F%E6%97%B6%E5%90%8E%E6%81%A2%E5%A4%8D%E6%AD%A3%E5%B8%B8%EF%BC%8C%E5%88%99%E8%A7%A3%E9%99%A4%E5%B0%81%E7%A6%81"><span class="toc-number">17.</span> <span class="toc-text">根据web访问日志，封禁请求量异常的IP，如IP在半小时后恢复正常，则解除封禁</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7%E8%BE%93%E5%85%A5%E7%9A%84%E6%98%AF%E5%90%A6%E4%B8%BAIP%E5%9C%B0%E5%9D%80"><span class="toc-number">18.</span> <span class="toc-text">判断用户输入的是否为IP地址</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2023 - 2025 By ZhangYuhan</div><div class="footer_custom_text">Hi, welcome to my blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Switch Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="Scroll To Comments"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="Back To Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'JkudL31UMA3LTrugX1MyaDSI-MdYXbMMI',
      appKey: 'G7H3CF0evPfzlwg7MCAK3ZJY',
      avatar: 'monsterid',
      serverURLs: 'https://jkudl31u.api.lncldglobal.com',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: true
    }, {"placeholder":"leave your comment (*￣▽￣*)ブ\nPs: Users in mainland China may need to surf the Internet scientifically to successfully load and submit comments\n","pageSize":15,"lang":"en"}))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><canvas id="universe"></canvas><script defer src="/js/universe.js"></scrip><script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script><script type="text/javascript" src="/js/dynamicBg.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></body></html>